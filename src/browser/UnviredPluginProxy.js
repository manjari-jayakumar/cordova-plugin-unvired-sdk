var loginParameters,metadata={sMeta:[],fMeta:[],bMeta:[]},loginType={unvired:"UNVIRED_ID",ads:"ADS",sap:"SAP",custom:"CUSTOM"},requestType={RQST:0,PULL:1,PUSH:2,QUERY:3,REQ:4},loginMode={authActivate:0,authLocal:1,forgotPassword:2};module.exports.login=function(e,t,a){if(console.log("Unvired Plugin Login Options:"+JSON.stringify(a)),loginParameters=a[0],helper.clearLokiDbs(),metadataParser.initialize(),e){var r={type:0};e(r)}},module.exports.logout=function(e,t,a){helper.clearLokiDbs()},module.exports.getListOfFrontEndUsers=function(t,e,a){if(helper.validateLoginParameters(loginMode.authActivate,t)){restUtil.appMeta={},restUtil.appMeta.appName=loginParameters.appName,restUtil.appMeta.url=loginParameters.url,restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username+":"+loginParameters.password);var r=restUtil.appMeta.url+restApis.users+loginParameters.username;restUtil.performRequest(r,"",function(e){t(e)},restUtil.httpType.get)}},module.exports.authenticateAndActivate=function(u){if(helper.validateLoginParameters(loginMode.authActivate,u)){var c;switch(restUtil.appMeta={},restUtil.appMeta.frontEnd=loginParameters.feUserId,restUtil.appMeta.appName=loginParameters.appName,restUtil.appMeta.url=loginParameters.url,restUtil.appMeta.username=loginParameters.username,loginParameters.loginType){case loginType.unvired:restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username+":"+loginParameters.password),c=restUtil.appMeta.url+restApis.session;break;case loginType.sap:restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username),c=restUtil.appMeta.url+restApis.session+"applications/"+restUtil.appMeta.appName,restUtil.appMeta.credentials=JSON.stringify([{port:loginParameters.domain,user:loginParameters.username,password:loginParameters.password}]);break;case loginType.ads:restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username),c=restUtil.appMeta.url+restApis.session+"applications/"+restUtil.appMeta.appName,restUtil.appMeta.credentials=JSON.stringify([{port:loginParameters.port,user:loginParameters.domain+"\\"+loginParameters.username,password:loginParameters.password}])}restUtil.performRequest(c,"",function(e){if(e.type==resultType.success){for(var t=!1,a=0,r=e.data.users;a<r.length;a++){var o=r[a];if("BROWSER"===o.frontendType){var n=o.applications;if(!helper.isEmpty(n))for(var s=0,p=n;s<p.length;s++){p[s].name===restUtil.appMeta.appName&&(t=!0,restUtil.appMeta.frontEnd=o.name)}}}if(!t)u(i={type:3,error:"No Deployed application for frontend type of BROWSER found"});restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username+":"+e.data.authKey),c=restUtil.appMeta.url+restApis.session+e.data.sessionId,restUtil.performRequest(c,"",function(e){},restUtil.httpType.del),restUtil.appMeta.credentials="",webDb.initialize(),webDb.saveAppMeta(restUtil.appMeta),(i={type:2}).data=e,u(i)}else{var i,l="";helper.isEmpty(e)||(l=helper.isEmpty(e.error)?"No error description returned from server":JSON.parse(e.error).error),helper.sendError(l,u),(i={type:3}).error=l,u(i)}},restUtil.httpType.post)}},module.exports.authenticateLocal=function(e){helper.validateLoginParameters(loginMode.authLocal,e)&&alert("Api not supported on Web!")},module.exports.getAllAccounts=function(e){alert("Api not supported on Web!")},module.exports.switchAccount=function(e,t){alert("Api not supported on Web!")},module.exports.deleteAccount=function(e,t){alert("Api not supported on Web!")},module.exports.syncForeground=function(t,e,a,r,o,n){webDb.appDb.loadDatabase({}),restUtil.appMeta.url&&""!==restUtil.appMeta.url||(restUtil.appMeta=webDb.getAppMeta());var s=restUtil.appMeta.url+restApis.defaultApi+restUtil.appMeta.appName+restApis.execute+r,p="";null!==e&&""!==e||(p=a),p=restUtil.removeLokiMeta(p),restUtil.performRequest(s,p,function(e){return e.type==resultType.success&&o&&(e=parser.parseServerResponse(JSON.parse(e.data),t)),n(e)},restUtil.httpType.post)},module.exports.syncBackground=function(e,t,a,r,o,n,s,p){webDb.appDb.loadDatabase({}),restUtil.appMeta.url&&""!==restUtil.appMeta.url||(restUtil.appMeta=webDb.getAppMeta());var i=restUtil.appMeta.url+restApis.defaultApi+restUtil.appMeta.appName+restApis.execute+r,l="";null!==t&&""!==t||(l=a),l=restUtil.removeLokiMeta(l),restUtil.performRequest(i,l,function(e){return p(e)},restUtil.httpType.post)},module.exports.getMessages=function(e){alert("Api not supported on Web!")},module.exports.registerNotifListener=function(e){alert("'registerNotifListener' - Api not supported on Web! Web supports only sync call")},module.exports.unRegisterNotifListener=function(e){alert("'unRegisterNotifListener' - Api not supported on Web! Web supports only sync call")},module.exports.generateUBJson=function(e,t,a,r,o){var n=helper.getBeName(e),s={},p={};p[e]=t,p[a]=r,s[n]=[p],helper.sendSuccess("",o,s)},module.exports.parseRawUBJson=function(e,t){var a=JSON.parse(e),r={infoMessage:[],be:[]},o=[];for(var n in a)if(a.hasOwnProperty(n))if("InfoMessage"===n){var s=a[n];r.infoMessage=s}else{a[n].forEach(function(e){var t={header:"",items:[]};for(var a in e)if(e.hasOwnProperty(a)){var r=e[a];r.constructor===Array?r.forEach(function(e){t.items.push(e)}):r.constructor===Object&&(t.header=r)}o.push(t)})}r.be=o,t(r)},module.exports.dbSelect=function(e,t,a){webDb.appDb.loadDatabase({});var r=webDb.select(e,t);return helper.sendSuccess("",a,r)},module.exports.dbInsert=function(e,t,a,r){return a||helper.isEmpty(t.FID)&&helper.sendError("Invalid FID",r),webDb.insert(e,t,!1),helper.sendSuccess("",r,"")},module.exports.dbInsertOrUpdate=function(e,t,a,r){return a||helper.isEmpty(t.FID)&&helper.sendError("Invalid FID",r),webDb.insert(e,t,!1),helper.sendSuccess("",r,"")},module.exports.dbDeleteRecord=function(t,e,a){var r=webDb.select(t,e);null!=r&&0<r.length&&r.forEach(function(e){webDb.deleteCascade(t,e)}),helper.sendSuccess("Record deleted successfully",a)},module.exports.dbUpdate=function(e,o,t,a){var n=webDb.appDb.getCollection(e);if(null!==n){var r=n.find({$and:[t]});null!==r?(r.forEach(function(r){Object.keys(o).forEach(function(e,t){var a=o[e];r[e]=a,n.update(r)})}),webDb.appDb.saveDatabase(),helper.sendSuccess(r.length+" Record updated",a)):helper.sendSuccess("No records found",a)}else helper.sendError("Table"+e+" not found!",a)},module.exports.dbExecuteStatement=function(e,t,a){alert("Api not supported on web!. Use select api instead.")},module.exports.dbGetCollection=function(e,t){t(webDb.appDb.getCollection(e))},module.exports.dbCreateSavePoint=function(e,t){alert("Api not supported on web!.")},module.exports.dbReleaseSavePoint=function(e,t){alert("Api not supported on web!.")},module.exports.dbRollbackSavePoint=function(e,t){alert("Api not supported on web!.")},module.exports.dbReload=function(e){webDb.reload(),restUtil.appMeta.url&&""!==restUtil.appMeta.url||(restUtil.appMeta=webDb.getAppMeta()),metadataParser.initialize()},module.exports.getAttachmentFolderPath=function(e){console.log("ump.attachment.getAttachmentFolderPath - Api not supported in browser!")},module.exports.createAttachmentItem=function(e,t,a){console.log("ump.attachment.createAttachmentItem - Api not supported in browser!")},module.exports.uploadAttachment=function(e,t,a,r){alert("ump.attachment.createAttachmentItem - Api not supported yet in browser!")},module.exports.downloadAttachment=function(e,t,a){alert("ump.attachment.downloadAttachment - Api not supported yet in browser!")},module.exports.getInfoMessages=function(e,t,a){var r=helper.getInfoMessages(t);helper.sendSuccess("",a,r)},module.exports.showSettings=function(){alert("Api not supported on Web!")},module.exports.userSettings=function(e){var t=getAppMeta();return t.USER_ID=t.username,helper.sendSuccess("",e,getAppMeta())},module.exports.updateSystemCredentials=function(e,t){alert("Api not supported on web!.")},module.exports.getSystemCredentials=function(e){alert("Api not supported on web!.")},module.exports.getVersionNumbers=function(e){alert("Api not implemented on Web!")},module.exports.clearData=function(e){helper.clearLokiDbs()},module.exports.reCreateAppDB=function(e){webDb.reCreateAppDb(),helper.sendSuccess("",e,!0)},module.exports.pullDb=function(e){alert("Api not supported on Web!")},module.exports.pushDB=function(e){alert("Api not supported on Web!")},module.exports.encrypt=function(e,t){alert("Api not supported on Web!")},module.exports.getAppMeta=function(e){e(webDb.getAppMeta())},module.exports.guid=function(e){e(helper.guid())},module.exports.hasInternet=function(e){helper.sendSuccess("",e,!0)},module.exports.logError=function(e,t,a){console.log("ERROR | "+e+" | "+t+" | "+a)},module.exports.logDebug=function(e,t,a){console.log("DEBUG | "+e+" | "+t+" | "+a)},module.exports.logImportant=function(e,t,a){console.log("IMPORTANT | "+e+" | "+t+" | "+a)},module.exports.logRead=function(e){console.log("Api not supported on Web!")},module.exports.logDelete=function(){console.log("Api not supported on Web!")},module.exports.sendLogToServer=function(e){console.log("Api not supported on Web!")},module.exports.sendLogViaEmail=function(e){console.log("Api not supported in Web!")};var helper=function(){function r(){}return r.getBeName=function(t){return metadata.sMeta.filter(function(e){return e.name===t})[0].beName},r.getBeHeaderName=function(t){var a="";return metadata.sMeta.forEach(function(e){e.beName===t&&!0===e.isheader&&(a=e.name)}),a},r.getBeChildrenNames=function(t){var a=metadata.sMeta.filter(function(e){return e.name===t});return a=metadata.sMeta.filter(function(e){return e.beName===a[0].beName&&!1===e.isheader})},r.getBeTableNames=function(t){return metadata.sMeta.filter(function(e){return e.beName===t})},r.saveInfoMessage=function(e,t,a){var r=webDb.appDb.getCollection("InfoMessage");null===r&&(r=webDb.appDb.addCollection("InfoMessage")),e.beName=t,e.beLid=a,r.insert(e),webDb.appDb.saveDatabase()},r.getInfoMessages=function(e){if(null==webDb.appDb.getCollection("InfoMessage"))return[];var t=webDb.select("InfoMessage",JSON.stringify({beLid:e}),!0);return null==t?[]:t},r.isEmpty=function(e){return null==e||null===e||""===e},r.copyProperty=function(e,t){for(var a in e)t[a]=e[a];return t},r.validateLoginParameters=function(e,t){if(r.isEmpty(loginParameters.appName))return r.sendError("Please provide Application Name!",t),!1;if(r.isEmpty(loginParameters.loginType))return r.sendError("Incorrect Login Type!",t),!1;if((loginParameters.loginType===loginType.sap||loginParameters.loginType===loginType.ads)&&!loginParameters.domain)return r.sendError("Please provide Domain!",t),!1;if(r.isEmpty(e))return r.sendError("Please set Login Mode!",t),!1;var a=void 0;switch(e){case loginMode.authActivate:if(r.isEmpty(loginParameters.url)?a="Please provide Url!":r.isEmpty(loginParameters.company)?a="Please provide Company Name!":r.isEmpty(loginParameters.username)?a="Please provide User Id!":r.isEmpty(loginParameters.password)&&(a="Please provide Password!"),a)return r.sendError(a,t),!1;break;case loginMode.authLocal:if(r.isEmpty(loginParameters.username)?a="Please provide User Id!":r.isEmpty(loginParameters.password)&&(a="Please provide Password!"),a)return r.sendError(a,t),!1;break;case loginMode.forgotPassword:}return!0},r.guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1).toUpperCase()}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},r.clearLokiDbs=function(){localStorage.removeItem("APP_LOKI_DB"),localStorage.removeItem("FW_LOKI_DB"),localStorage.removeItem(loginParameters.appName),webDb.appDb=null,webDb.fwDb=null},r.sendError=function(e,t){var a={};a.type=resultType.error,a.error=e,t(a)},r.sendSuccess=function(e,t,a){var r={};r.type=resultType.success,r.error=e,r.data=a,t(r)},r}(),restUtil=function(){function p(){}return p.performRequest=function(e,t,a,r){var o={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Authorization:p.appMeta.authorization},n={frontendUser:p.appMeta.frontEnd,messageFormat:"standard",inputMessage:JSON.stringify(t),credentials:p.appMeta.credentials},s=r||"POST";$.ajax({type:s,url:e,data:n,success:function(e){p.hanldeRestApiCallback(!0,e,a)},error:function(e){p.hanldeRestApiCallback(!1,e,a)},headers:o,dataType:"json"})},p.hanldeRestApiCallback=function(e,t,a){var r={};e?(r.type=resultType.success,r.message=t&&t.message?t.message:"",r.data=t):(r.type=resultType.error,r.error=t&&t.responseText?t.responseText:"",r.message=t&&t.message?t.message:""),a(r)},p.removeLokiMeta=function(e){return""!=e&&(e=JSON.parse(JSON.stringify(e))),function e(t){for(var a in t)t[a]&&"object"==typeof t[a]&&(delete t.$loki,delete t.meta,e(t[a]))}(e),e},p.appMeta={},p.httpType={get:"GET",post:"POST",del:"DELETE"},p}(),webDb=function(){function l(){}return l.initialize=function(){var e=helper.isEmpty(loginParameters.appName)?"APP_LOKI_DB":loginParameters.appName;if(null==l.appDb){var t=new LokiIndexedAdapter;(l.appDb=new loki(e,{adapter:t,autoload:!0})).loadDatabase({}),l.appDb.saveDatabase()}null==l.fwDb&&((l.fwDb=new loki("FW_LOKI_DB")).loadDatabase({}),l.fwDb.saveDatabase())},l.reload=function(){var e=helper.isEmpty(loginParameters.appName)?"APP_LOKI_DB":loginParameters.appName;null==l.appDb&&((l.appDb=new loki(e)).loadDatabase(JSON.parse(localStorage[e])),l.appDb.saveDatabase()),null==l.fwDb&&((l.fwDb=new loki("FW_LOKI_DB")).loadDatabase(JSON.parse(localStorage.FW_LOKI_DB)),l.fwDb.saveDatabase())},l.insert=function(e,t,a){var r=a?l.fwDb:l.appDb,o=r.getCollection(e);null==o&&(o=r.addCollection(e));var n=null;a||(n=l.getBasedOnGid(e,t)),null==n?(helper.isEmpty(t.LID)&&(t.LID=helper.guid()),o.insert(t)):(t=helper.copyProperty(t,n),o.update(t)),r.saveDatabase()},l.select=function(e,t,a){var r=(a?l.fwDb:l.appDb).getCollection(e);return null===r?[]:helper.isEmpty(t)?r.data:r.findObjects(t)},l.deleteCascade=function(e,t,a){var r=a?l.fwDb:l.appDb,o=l.getBasedOnGid(e,t);if(o&&null!=o){var n=helper.getBeChildrenNames(e);if(null!=n&&0<n.length)for(var s=0;s<n.length;s++){var p=r.getCollection(n[s].name);null!=p&&p.removeWhere({FID:o.LID})}var i=r.getCollection(e);null!=i&&i.removeWhere({LID:o.LID})}r.saveDatabase()},l.getCollection=function(e){return l.appDb.getCollection(name)},l.saveAppMeta=function(e){l.insert("appMeta",e,!0)},l.getAppMeta=function(){var e=l.select("appMeta","",!0);return null!=e&&0<e.length?e[0]:null},l.getBasedOnGid=function(t,a){if(helper.isEmpty(t))return null;var e=metadata.fMeta.filter(function(e){return e.sName===t&&!0===e.isGid});if(null==e||e.length<=0)return null;var r={};e.forEach(function(e){r[e.name]=a[e.name]});var o=l.appDb.getCollection(t);return null===o?null:o.findObject(r)},l.reCreateAppDb=function(){var e=helper.isEmpty(loginParameters.appName)?"APP_LOKI_DB":loginParameters.appName;localStorage.removeItem("APP_LOKI_DB"),localStorage.removeItem(loginParameters.appName);var t=new LokiIndexedAdapter;(l.appDb=new loki(e,{adapter:t,autoload:!0})).loadDatabase({}),l.appDb.saveDatabase()},l.appDb=null,l.fwDb=null,l}(),parser=function(){function i(){}return i.parseServerResponse=function(e,t){var a={};a.type=resultType.success,a.data=e,a.message="",e.hasOwnProperty("InfoMessage")&&e.InfoMessage.forEach(function(e){helper.saveInfoMessage(e),a.message=a.message+" "+e.message,"FAILURE"===e.category&&(a.type=resultType.error)});for(var r in e)if("InfoMessage"!==r){var o=e[r];if(t==requestType.PULL){var n=helper.getBeTableNames(r);if(null!=n&&0<n.length)for(var s=0;s<n.length;s++){var p=webDb.appDb.getCollection(n[s].name);null!=p&&p.clear()}}o.forEach(function(e){i.handleEachBE(e,t,r)})}return webDb.appDb.saveDatabase(),a},i.handleEachBE=function(e,t,a){var r="",o=!1;for(var n in e)if(e.hasOwnProperty(n)){var s=e[n];if(s.constructor===Array)s.forEach(function(e){e.FID=r;var t=webDb.getBasedOnGid(n,e),a=webDb.appDb.getCollection(n);null===a&&(a=webDb.appDb.addCollection(n)),null==t?(e.FID=r,a.insert(e)):(e=helper.copyProperty(e,t),a.update(e))});else if(s.constructor===Object){if(s.LID=helper.guid(),r=s.LID,o){webDb.deleteCascade(n,s);continue}var p=webDb.getBasedOnGid(n,s);if(t===requestType.RQST&&p&&null!=p){var i=helper.getBeChildrenNames(n);if(null!=i&&0<i.length)for(var l=0;l<i.length;l++){var u=webDb.appDb.getCollection(i[l].name);null!=u&&u.removeWhere({FID:p.LID})}}var c=webDb.appDb.getCollection(n);null===c&&(c=webDb.appDb.addCollection(n)),null==p?(s.LID=helper.guid(),c.insert(s)):(s=helper.copyProperty(s,p),c.update(s)),r=s.LID}else o="D"==s}},i}(),metadataParser=function(){function o(){}return o.initialize=function(){o.loadJSON(o.parse)},o.loadJSON=function(e){var t=new XMLHttpRequest;t.overrideMimeType("application/json");var a=helper.isEmpty(loginParameters.metadataPath)?"metadata.json":loginParameters.metadataPath;t.open("GET",a,!0),t.onreadystatechange=function(){4==t.readyState&&200==t.status&&e(t.responseText)},t.send(null)},o.parse=function(e){if(!helper.isEmpty(e)){var t=JSON.parse(e);for(var a in t)if(t.hasOwnProperty(a)){var r=t[a];r.constructor===Object&&o.parseEachBE(r,a)}}},o.parseEachBE=function(e,t){var a={};for(var r in a.attachment=!helper.isEmpty(e.attachments)&&e.attachments,a.onConflict=helper.isEmpty(e.onConflict)?conflictRule.SERVER_WINS:e.onConflict,a.save=!!helper.isEmpty(e.save)||e.save,a.name=t,metadata.bMeta.push(a),e)if(e.hasOwnProperty(r)){var o=e[r];if(o.constructor===Object){var n={};n.beName=a.name,n.isheader=-1<r.indexOf("_HEADER")||-1<r.indexOf("_HDR"),n.name=r,metadata.sMeta.push(n);var s=o.field;null!=s&&0<s.length&&s.forEach(function(e){var t={};t.beName=a.name,t.sName=n.name,t.name=e.name,t.isGid=e.isGid,t.isMandatory=e.mandatory,t.sqlType=e.sqlType,metadata.fMeta.push(t)})}}},o}();require("cordova/exec/proxy").add("LoginPlugin",module.exports),require("cordova/exec/proxy").add("LoggerPlugin",module.exports),require("cordova/exec/proxy").add("SyncEnginePlugin",module.exports),require("cordova/exec/proxy").add("AttachmentPlugin",module.exports),require("cordova/exec/proxy").add("SettingsPlugin",module.exports);