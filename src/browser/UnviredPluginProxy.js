var loginParameters,restApis={defaultApi:"/UMP/API/v2/applications/",activate:"/activate/",authenticate:"/authenticate",session:"/UMP/API/v2/session/",execute:"/execute/",users:"/UMP/API/v2/users/"},metadata={sMeta:[],fMeta:[],bMeta:[]},loginType={unvired:"UNVIRED_ID",ads:"ADS",sap:"SAP",custom:"CUSTOM",email:"EMAIL"},requestType={RQST:"RQST",PULL:"PULL",PUSH:"PUSH",QUERY:"QUERY",REQ:"REQ"},loginMode={authActivate:0,authLocal:1,forgotPassword:2},resultType={success:0,error:1};module.exports.login=function(e,t,a){if(console.log("Unvired Plugin Login Options:"+JSON.stringify(a)),loginParameters=a[0],helper.clearLokiDbs(),metadataParser.initialize(),e){var r={type:0};e(r)}},module.exports.logout=function(e,t,a){helper.clearLokiDbs()},module.exports.getListOfFrontEndUsers=function(t,e,a){if(helper.validateLoginParameters(loginMode.authActivate,t)){restUtil.appMeta={},restUtil.appMeta.appName=loginParameters.appName,restUtil.appMeta.url=loginParameters.url,restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username+":"+loginParameters.password);var r=restUtil.appMeta.url+restApis.users+loginParameters.username;restUtil.performRequest(r,"",function(e){t(e)},restUtil.httpType.get,!1)}},module.exports.authenticateAndActivate=function(u,e){if(helper.validateLoginParameters(loginMode.authActivate,u)){var c;switch(restUtil.appMeta={},restUtil.appMeta.frontEnd=loginParameters.feUserId,restUtil.appMeta.appName=loginParameters.appName,restUtil.appMeta.url=loginParameters.url,restUtil.appMeta.username=loginParameters.username,loginParameters.loginType){case loginType.email:case loginType.unvired:restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username+":"+loginParameters.password),c=restUtil.appMeta.url+restApis.session;break;case loginType.sap:restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username),c=restUtil.appMeta.url+restApis.session+"applications/"+restUtil.appMeta.appName,restUtil.appMeta.credentials=JSON.stringify([{port:loginParameters.domain,user:loginParameters.username,password:loginParameters.password}]);break;case loginType.ads:restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username),c=restUtil.appMeta.url+restApis.session+"applications/"+restUtil.appMeta.appName,restUtil.appMeta.credentials=JSON.stringify([{port:loginParameters.port,user:loginParameters.domain+"\\"+loginParameters.username,password:loginParameters.password}])}restUtil.performRequest(c,"",function(e){if(e.type==resultType.success){for(var t=!1,a=0,r=e.data.users;a<r.length;a++){var o=r[a];if("BROWSER"===o.frontendType){var n=o.applications;if(!helper.isEmpty(n))for(var s=0,i=n;s<i.length;s++){i[s].name===restUtil.appMeta.appName&&(t=!0,restUtil.appMeta.frontEnd=o.name)}}}if(!t)u(l={type:3,error:"No Deployed application for frontend type of BROWSER found"});restUtil.appMeta.authorization="Basic "+window.btoa(loginParameters.company+"\\"+loginParameters.username+":"+e.data.authKey),c=restUtil.appMeta.url+restApis.session+e.data.sessionId,restUtil.performRequest(c,"",function(e){},restUtil.httpType.del,!1),restUtil.appMeta.credentials="",webDb.initialize(),webDb.saveAppMeta(restUtil.appMeta),(l={type:2}).data=e,u(l)}else{var l,p="";helper.isEmpty(e)||(p=helper.isEmpty(e.error)?"No error description returned from server":JSON.parse(e.error).error),(l={type:3}).error=p,u(l)}},restUtil.httpType.post,!1)}},module.exports.authenticateLocal=function(e,t,a){helper.validateLoginParameters(loginMode.authLocal,e)&&alert("Api not supported on Web!")},module.exports.getAllAccount=function(e,t,a){alert("Api not supported on Web!")},module.exports.switchAccount=function(e,t,a){a.account;alert("Api not supported on Web!")},module.exports.deleteAccount=function(e,t,a){alert("Api not supported on Web!")},module.exports.submitInSync=function(t,e,a){console.log("OPTIONS: "+JSON.stringify(a,null,2));var r,o,n,s,i;r=a[0].requestType,o=a[0].header,n=a[0].customData,s=a[0].paFunction,i=a[0].autoSave,webDb.appDb.loadDatabase({}),restUtil.appMeta.url&&""!==restUtil.appMeta.url||(restUtil.appMeta=webDb.getAppMeta());var l=restUtil.appMeta.url+restApis.defaultApi+restUtil.appMeta.appName+restApis.execute+s;console.log("End Point: "+l);var p="";null!==o&&""!==o||(p=n),p=restUtil.removeLokiMeta(p),restUtil.performRequest(l,p,function(e){return e.type==resultType.success&&i&&(e=parser.parseServerResponse(JSON.parse(e.data),r)),t(e)},restUtil.httpType.post,!1)},module.exports.submitInASync=function(t,e,a){var r,o,n;reqype=a[0].requestType,r=a[0].header,o=a[0].customData,n=a[0].paFunction,autosave=a[0].autoSave,webDb.appDb.loadDatabase({}),restUtil.appMeta.url&&""!==restUtil.appMeta.url||(restUtil.appMeta=webDb.getAppMeta());var s=restUtil.appMeta.url+restApis.defaultApi+restUtil.appMeta.appName+restApis.execute+n,i="";null!==r&&""!==r||(i=o),i=restUtil.removeLokiMeta(i),restUtil.performRequest(s,i,function(e){return t(e)},restUtil.httpType.post,!0)},module.exports.getMessages=function(e,t,a){alert("Api not supported on Web!")},module.exports.registerNotifListener=function(e,t,a){alert("'registerNotifListener' - Api not supported on Web! Web supports only sync call")},module.exports.unRegisterNotifListener=function(e,t,a){alert("'unRegisterNotifListener' - Api not supported on Web! Web supports only sync call")},module.exports.generateUBJson=function(e,t,a){var r,o,n,s;r=a[0].headerName,o=a[0].header,n=a[0].itemName,s=a[0].items;var i=helper.getBeName(r),l={},p={};p[r]=o,p[n]=s,l[i]=[p],helper.sendSuccess("",e,l)},module.exports.parseRawUBJson=function(e,t,a){var r;r=a[0].json;var o=JSON.parse(r),n={infoMessage:[],be:[]},s=[];for(var i in o)if(o.hasOwnProperty(i))if("InfoMessage"===i){var l=o[i];n.infoMessage=l}else{o[i].forEach(function(e){var t={header:"",items:[]};for(var a in e)if(e.hasOwnProperty(a)){var r=e[a];r.constructor===Array?r.forEach(function(e){t.items.push(e)}):r.constructor===Object&&(t.header=r)}s.push(t)})}n.be=s,e(n)},module.exports.select=function(e,t,a){var r,o;r=a[0].tableName,o=a[0].whereClause,webDb.appDb.loadDatabase({});var n=webDb.select(r,o);return helper.sendSuccess("",e,n)},module.exports.insert=function(e,t,a){var r,o,n;return r=a[0].tableName,n=a[0].isHeader,o=a[0].fields,n||helper.isEmpty(o.FID)&&helper.sendError("Invalid FID",e),webDb.insert(r,o,!1),helper.sendSuccess("",e,"")},module.exports.insertOrUpdate=function(e,t,a){var r,o,n;return r=a[0].tableName,n=a[0].isHeader,o=a[0].fields,n||helper.isEmpty(o.FID)&&helper.sendError("Invalid FID",e),webDb.insert(r,o,!1),helper.sendSuccess("",e,"")},module.exports.deleteRecord=function(e,t,a){var r,o;r=a.tableName,o=a.whereClause;var n=webDb.select(r,o);null!=n&&0<n.length&&n.forEach(function(e){webDb.deleteCascade(r,e)}),helper.sendSuccess("Record deleted successfully",e)},module.exports.update=function(e,t,a){var r,o,n;r=a[0].tableName,n=a[0].whereClause,o=a[0].fields;var s=webDb.appDb.getCollection(r);if(null!==s){var i=s.find({$and:[n]});null!==i?(i.forEach(function(r){Object.keys(o).forEach(function(e,t){var a=o[e];r[e]=a,s.update(r)})}),webDb.appDb.saveDatabase(),helper.sendSuccess(i.length+" Record updated",e)):helper.sendSuccess("No records found",e)}else helper.sendError("Table"+r+" not found!",e)},module.exports.executeQuery=function(e,t,a){a[0].query,alert("Api not supported on web!. Use select api instead.")},module.exports.dbGetCollection=function(e,t,a){var r;r=a.tableName,e(webDb.appDb.getCollection(r))},module.exports.createSavePoint=function(e,t,a){alert("Api not supported on web!.")},module.exports.releaseSavePoint=function(e,t,a){alert("Api not supported on web!.")},module.exports.rollbackSavePoint=function(e,t,a){alert("Api not supported on web!.")},module.exports.beginTransaction=function(e,t,a){alert("Api not supported on web!.")},module.exports.endTransaction=function(e,t,a){alert("Api not supported on web!.")},module.exports.launchFile=function(e,t,a){alert("Api not supported on web!.")},module.exports.unzip=function(e,t,a){alert("Api not supported on web!.")},module.exports.launchBase64=function(e,t,a){alert("Api not supported on web!.")},module.exports.dbReload=function(e,t,a){webDb.reload(),restUtil.appMeta.url&&""!==restUtil.appMeta.url||(restUtil.appMeta=webDb.getAppMeta()),metadataParser.initialize()},module.exports.getAttachmentFolderPath=function(e,t,a){console.log("ump.attachment.getAttachmentFolderPath - Api not supported in browser!")},module.exports.createAttachmentItem=function(e,t,a){console.log("ump.attachment.createAttachmentItem - Api not supported in browser!")},module.exports.uploadAttachment=function(e,t,a){alert("ump.attachment.createAttachmentItem - Api not supported yet in browser!")},module.exports.downloadAttachment=function(e,t,a){alert("ump.attachment.downloadAttachment - Api not supported yet in browser!")},module.exports.getInfoMessages=function(e,t,a){var r;a[0].headerName,r=a[0].LID;var o=helper.getInfoMessages(r);helper.sendSuccess("",sucessCallback,o)},module.exports.showSettings=function(e,t,a){alert("Api not supported on Web!")},module.exports.userSettings=function(e,t,a){var r=webDb.getAppMeta();return r.USER_ID=r.username,loginParameters.loginType==loginType.email&&(r.EMAIL=r.username),helper.sendSuccess("",e,r)},module.exports.updateSystemCredentials=function(e,t,a){alert("Api not supported on web!.")},module.exports.getSystemCredentials=function(e,t,a){alert("Api not supported on web!.")},module.exports.getVersionNumbers=function(e,t,a){alert("Api not implemented on Web!")},module.exports.clearData=function(e,t,a){helper.clearLokiDbs()},module.exports.reCreateAppDB=function(e,t,a){webDb.reCreateAppDb(),helper.sendSuccess("",sucessCallback,!0)},module.exports.pullDb=function(e,t,a){alert("Api not supported on Web!")},module.exports.pushDb=function(e,t,a){alert("Api not supported on Web!")},module.exports.encrypt=function(e,t,a){alert("Api not supported on Web!")},module.exports.getAppMeta=function(e,t,a){e(webDb.getAppMeta())},module.exports.guid=function(e,t,a){e(helper.guid())},module.exports.hasInternet=function(e,t,a){helper.sendSuccess("",e,!0)},module.exports.logError=function(e,t,a){var r,o,n;r=a[0].srcClass,o=a[0].srcMethod,n=a[0].message,console.log("ERROR | "+r+" | "+o+" | "+n)},module.exports.logDebug=function(e,t,a){var r,o,n;r=a[0].srcClass,o=a[0].srcMethod,n=a[0].message,console.log("DEBUG | "+r+" | "+o+" | "+n)},module.exports.logInfo=function(e,t,a){var r,o,n;r=a[0].srcClass,o=a[0].srcMethod,n=a[0].message,console.log("IMPORTANT | "+r+" | "+o+" | "+n)},module.exports.getLogs=function(e,t,a){console.log("Api not supported on Web!")},module.exports.deleteLogs=function(e,t,a){console.log("Api not supported on Web!")},module.exports.sendViaServer=function(e,t,a){console.log("Api not supported on Web!")},module.exports.sendViaEmail=function(e,t,a){console.log("Api not supported in Web!")};var helper=function(){function r(){}return r.getBeName=function(t){return metadata.sMeta.filter(function(e){return e.name===t})[0].beName},r.getBeHeaderName=function(t){var a="";return metadata.sMeta.forEach(function(e){e.beName===t&&!0===e.isheader&&(a=e.name)}),a},r.getBeChildrenNames=function(t){var a=metadata.sMeta.filter(function(e){return e.name===t});return a=metadata.sMeta.filter(function(e){return e.beName===a[0].beName&&!1===e.isheader})},r.getBeTableNames=function(t){return metadata.sMeta.filter(function(e){return e.beName===t})},r.saveInfoMessage=function(e,t,a){var r=webDb.appDb.getCollection("InfoMessage");null===r&&(r=webDb.appDb.addCollection("InfoMessage")),e.beName=t,e.beLid=a,r.insert(e),webDb.appDb.saveDatabase()},r.getInfoMessages=function(e){if(null==webDb.appDb.getCollection("InfoMessage"))return[];var t=webDb.select("InfoMessage",JSON.stringify({beLid:e}),!0);return null==t?[]:t},r.isEmpty=function(e){return null==e||null===e||""===e},r.copyProperty=function(e,t){for(var a in e)t[a]=e[a];return t},r.validateLoginParameters=function(e,t){if(r.isEmpty(loginParameters.appName))return r.sendError("Please provide Application Name!",t),!1;if(r.isEmpty(loginParameters.loginType))return r.sendError("Incorrect Login Type!",t),!1;if((loginParameters.loginType===loginType.sap||loginParameters.loginType===loginType.ads)&&!loginParameters.domain)return r.sendError("Please provide Domain!",t),!1;if(r.isEmpty(e))return r.sendError("Please set Login Mode!",t),!1;var a=void 0;switch(e){case loginMode.authActivate:if(r.isEmpty(loginParameters.url)?a="Please provide Url!":r.isEmpty(loginParameters.company)?a="Please provide Company Name!":r.isEmpty(loginParameters.username)?a="Please provide User Id!":r.isEmpty(loginParameters.password)&&(a="Please provide Password!"),a)return r.sendError(a,t),!1;break;case loginMode.authLocal:if(r.isEmpty(loginParameters.username)?a="Please provide User Id!":r.isEmpty(loginParameters.password)&&(a="Please provide Password!"),a)return r.sendError(a,t),!1;break;case loginMode.forgotPassword:}return!0},r.guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1).toUpperCase()}return e()+e()+"-"+e()+"-"+e()},r.clearLokiDbs=function(){localStorage.removeItem("APP_LOKI_DB"),localStorage.removeItem("FW_LOKI_DB"),localStorage.removeItem(loginParameters.appName),webDb.appDb=null,webDb.fwDb=null},r.sendError=function(e,t){var a={};a.type=resultType.error,a.error=e,t(a)},r.sendSuccess=function(e,t,a){var r={};r.type=resultType.success,r.error=e,r.data=a,t(r)},r}(),restUtil=function(){function l(){}return l.performRequest=function(e,t,a,r,o){var n={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Authorization:l.appMeta.authorization},s={frontendUser:l.appMeta.frontEnd,messageFormat:"standard",inputMessage:JSON.stringify(t),externalReference:helper.guid(),queuedExecute:o,credentials:l.appMeta.credentials},i=r||"POST";$.ajax({type:i,url:e,data:s,success:function(e){l.hanldeRestApiCallback(!0,e,a)},error:function(e){l.hanldeRestApiCallback(!1,e,a)},headers:n,dataType:"json"})},l.hanldeRestApiCallback=function(e,t,a){var r={};e?(r.type=resultType.success,r.message=t&&t.message?t.message:"",r.data=t):(r.type=resultType.error,r.error=t&&t.responseText?t.responseText:"",r.message=t&&t.message?t.message:""),a(r)},l.removeLokiMeta=function(e){return""!=e&&(e=JSON.parse(JSON.stringify(e))),function e(t){for(var a in t)t[a]&&"object"==typeof t[a]&&(delete t.$loki,delete t.meta,e(t[a]))}(e),e},l.appMeta={},l.httpType={get:"GET",post:"POST",del:"DELETE"},l}(),webDb=function(){function p(){}return p.initialize=function(){var e=helper.isEmpty(loginParameters.appName)?"APP_LOKI_DB":loginParameters.appName;if(null==p.appDb){var t=new LokiIndexedAdapter;(p.appDb=new loki(e,{adapter:t,autoload:!0,env:"BROWSER"})).loadDatabase({}),p.appDb.saveDatabase()}null==p.fwDb&&((p.fwDb=new loki("FW_LOKI_DB",{env:"BROWSER"})).loadDatabase({}),p.fwDb.saveDatabase())},p.reload=function(){var e=helper.isEmpty(loginParameters.appName)?"APP_LOKI_DB":loginParameters.appName;null==p.appDb&&((p.appDb=new loki(e,{env:"BROWSER"})).loadDatabase(JSON.parse(localStorage[e])),p.appDb.saveDatabase()),null==p.fwDb&&((p.fwDb=new loki("FW_LOKI_DB",{env:"BROWSER"})).loadDatabase(JSON.parse(localStorage.FW_LOKI_DB)),p.fwDb.saveDatabase())},p.insert=function(e,t,a){var r=a?p.fwDb:p.appDb,o=r.getCollection(e);null==o&&(o=r.addCollection(e));var n=null;a||(n=p.getBasedOnGid(e,t)),null==n?(helper.isEmpty(t.LID)&&(t.LID=helper.guid()),o.insert(t)):(t=helper.copyProperty(t,n),o.update(t)),r.saveDatabase()},p.select=function(e,t,a){var r=(a?p.fwDb:p.appDb).getCollection(e);return null===r?[]:helper.isEmpty(t)?r.data:r.findObjects(t)},p.deleteCascade=function(e,t,a){var r=a?p.fwDb:p.appDb,o=p.getBasedOnGid(e,t);if(o&&null!=o){var n=helper.getBeChildrenNames(e);if(null!=n&&0<n.length)for(var s=0;s<n.length;s++){var i=r.getCollection(n[s].name);null!=i&&i.removeWhere({FID:o.LID})}var l=r.getCollection(e);null!=l&&l.removeWhere({LID:o.LID})}r.saveDatabase()},p.getCollection=function(e){return p.appDb.getCollection(name)},p.saveAppMeta=function(e){p.insert("appMeta",e,!0)},p.getAppMeta=function(){var e=p.select("appMeta","",!0);return null!=e&&0<e.length?e[0]:null},p.getBasedOnGid=function(t,a){if(helper.isEmpty(t))return null;var e=metadata.fMeta.filter(function(e){return e.sName===t&&!0===e.isGid});if(null==e||e.length<=0)return null;var r={};e.forEach(function(e){r[e.name]=a[e.name]});var o=p.appDb.getCollection(t);return null===o?null:o.findObject(r)},p.reCreateAppDb=function(){var e=helper.isEmpty(loginParameters.appName)?"APP_LOKI_DB":loginParameters.appName;localStorage.removeItem("APP_LOKI_DB"),localStorage.removeItem(loginParameters.appName);var t=new LokiIndexedAdapter;(p.appDb=new loki(e,{adapter:t,autoload:!0,env:"BROWSER"})).loadDatabase({}),p.appDb.saveDatabase()},p.appDb=null,p.fwDb=null,p}(),parser=function(){function l(){}return l.parseServerResponse=function(e,t){var a={};a.type=resultType.success,a.data=e,a.message="",e.hasOwnProperty("InfoMessage")&&e.InfoMessage.forEach(function(e){helper.saveInfoMessage(e),a.message=a.message+" "+e.message,"FAILURE"===e.category&&(a.type=resultType.error)});for(var r in e)if("InfoMessage"!==r){var o=e[r];if(t==requestType.PULL){var n=helper.getBeTableNames(r);if(null!=n&&0<n.length)for(var s=0;s<n.length;s++){var i=webDb.appDb.getCollection(n[s].name);null!=i&&i.clear()}}o.forEach(function(e){l.handleEachBE(e,t,r)})}return webDb.appDb.saveDatabase(),a},l.handleEachBE=function(e,t,a){var r="",o=!1;for(var n in e)if(e.hasOwnProperty(n)){var s=e[n];if(s.constructor===Array)s.forEach(function(e){e.FID=r;var t=webDb.getBasedOnGid(n,e),a=webDb.appDb.getCollection(n);null===a&&(a=webDb.appDb.addCollection(n)),null==t?(e.FID=r,a.insert(e)):(e=helper.copyProperty(e,t),a.update(e))});else if(s.constructor===Object){if(s.LID=helper.guid(),r=s.LID,o){webDb.deleteCascade(n,s);continue}var i=webDb.getBasedOnGid(n,s);if(t===requestType.RQST&&i&&null!=i){var l=helper.getBeChildrenNames(n);if(null!=l&&0<l.length)for(var p=0;p<l.length;p++){var u=webDb.appDb.getCollection(l[p].name);null!=u&&u.removeWhere({FID:i.LID})}}var c=webDb.appDb.getCollection(n);null===c&&(c=webDb.appDb.addCollection(n)),null==i?(s.LID=helper.guid(),c.insert(s)):(s=helper.copyProperty(s,i),c.update(s)),r=s.LID}else o="D"==s}},l}(),metadataParser=function(){function o(){}return o.initialize=function(){0<loginParameters.metadataPath.length?o.loadJSON(o.parse):0<loginParameters.metadataJSON.length?o.parse(loginParameters.metadataJSON):console.log("ERROR: metadataJSON is empty. Set the JSON to loginParameters.metadataJSON")},o.loadJSON=function(e){var t=new XMLHttpRequest;t.overrideMimeType("application/json");var a=helper.isEmpty(loginParameters.metadataPath)?"metadata.json":loginParameters.metadataPath;t.open("GET",a,!0),t.onreadystatechange=function(){4==t.readyState&&200==t.status&&e(t.responseText)},t.send(null)},o.parse=function(e){if(!helper.isEmpty(e)){var t=JSON.parse(e);for(var a in t)if(t.hasOwnProperty(a)){var r=t[a];r.constructor===Object&&o.parseEachBE(r,a)}}},o.parseEachBE=function(e,t){var a={};for(var r in a.attachment=!helper.isEmpty(e.attachments)&&e.attachments,a.onConflict=helper.isEmpty(e.onConflict)?conflictRule.SERVER_WINS:e.onConflict,a.save=!!helper.isEmpty(e.save)||e.save,a.name=t,metadata.bMeta.push(a),e)if(e.hasOwnProperty(r)){var o=e[r];if(o.constructor===Object){var n={};n.beName=a.name,n.isheader=-1<r.indexOf("_HEADER")||-1<r.indexOf("_HDR"),n.name=r,metadata.sMeta.push(n);var s=o.field;null!=s&&0<s.length&&s.forEach(function(e){var t={};t.beName=a.name,t.sName=n.name,t.name=e.name,t.isGid=e.isGid,t.isMandatory=e.mandatory,t.sqlType=e.sqlType,metadata.fMeta.push(t)})}}},o}();require("cordova/exec/proxy").add("LoginPlugin",module.exports),require("cordova/exec/proxy").add("LoggerPlugin",module.exports),require("cordova/exec/proxy").add("SyncEnginePlugin",module.exports),require("cordova/exec/proxy").add("AttachmentPlugin",module.exports),require("cordova/exec/proxy").add("SettingsPlugin",module.exports),require("cordova/exec/proxy").add("DatabasePlugin",module.exports);
